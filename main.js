(()=>{"use strict";function e(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",r)}function t(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",r)}function n(t){var n=t.target.closest(".card").querySelector(".card__title"),r=document.querySelector(".popup_type_image .popup__image"),o=document.querySelector(".popup_type_image .popup__caption");r.src=t.target.src,r.alt=t.target.alt,o.textContent=n.textContent,e(document.querySelector(".popup_type_image"))}function r(e){if("Escape"===e.key){var n=document.querySelector(".popup_is-opened");n&&t(n)}}var o={url:"https://nomoreparties.co/v1/wff-cohort-42",headers:{authorization:"e9f1a4a8-3394-4c77-b24a-f38f53566cda","Content-Type":"application/json"}},c=document.querySelector("#card-template").content;function u(e,t,n,r,o){var u=c.querySelector(".card").cloneNode(!0),a=u.querySelector(".card__image"),i=u.querySelector(".card__title"),l=u.querySelector(".card__delete-button"),s=u.querySelector(".card__like-button"),d=u.querySelector(".card__like-count"),p=u.querySelector(".card__delete-button");return u.dataset.cardId=t.id,a.src=t.link,a.alt=t.name,i.textContent=t.name,void 0!==t.likes&&t.likes.length>0&&(d.textContent=t.likes.length),void 0!==t.owner&&void 0!==t.owner.id&&e===t.owner.id&&p.classList.add("card__delete-button-visible"),l.addEventListener("click",n),s.addEventListener("click",r),a.addEventListener("click",o),void 0!==t.likes&&t.likes.forEach((function(t){t.id===e&&s.classList.add("card__like-button_is-active")})),u}function a(t,n){n.dataset.cardId=t.id,e(n)}function i(e,t){var n,r=t.target.classList.toggle("card__like-button_is-active"),c=t.currentTarget.closest(".card").querySelector(".card__like-count");r?(n=e.id,fetch("".concat(o.url,"/cards/likes/").concat(n),{method:"PUT",headers:o.headers}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка запроса лайка карты ",e)}))).then((function(e){c.textContent=e.likes.length})):function(e){return fetch("".concat(o.url,"/cards/likes/").concat(e),{method:"DELETE",headers:o.headers}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка запроса удаления лайка карты ",e)}))}(e.id).then((function(t){void 0!==e.likes||0===t.likes.length?c.textContent="":c.textContent=t.likes.length}))}function l(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(n){n.setCustomValidity(""),s(e,n,t)})),d(n,r,t)}function s(e,t,n){var r=p(e,t);t.classList.remove(n.inputErrorClass),r.textContent="",r.classList.remove(n.errorClass)}function d(e,t,n){var r=e.some((function(e){return!e.validity.valid}));t.disabled=r,t.classList.toggle(n.inactiveButtonClass,r)}function p(e,t){return e.querySelector(".".concat(t.id,"-error"))}var f=document.querySelector(".places__list"),_=document.querySelector(".profile__edit-button"),m=document.querySelector(".popup_type_edit"),y=document.querySelector(".profile__add-button"),h=document.querySelector(".profile__image"),v=document.querySelector(".popup_type_new-card"),S=document.querySelector(".popup_type_image"),q=document.querySelector(".popup_confirmation_delete"),k=document.querySelector(".popup_profile_image"),C=m.querySelector(".popup__form"),b=k.querySelector(".popup__form"),g=v.querySelector(".popup__form"),E=q.querySelector(".popup__form"),L=m.querySelector(".popup__input_type_name"),x=document.querySelector(".profile__title"),w=m.querySelector(".popup__input_type_description"),j=document.querySelector(".profile__description"),T=v.querySelector(".popup__input_type_card-name"),A=v.querySelector(".popup__input_type_url"),D=k.querySelector(".popup__input_type_url"),B=document.querySelector(".profile__image"),I="",M={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};_.addEventListener("click",(function(){L.value=x.textContent,w.value=j.textContent,l(C,M),e(m)})),y.addEventListener("click",(function(){g.reset(),l(g,M),e(v)})),h.addEventListener("click",(function(){b.reset(),l(b,M),e(k)})),C.addEventListener("submit",(function(e){e.preventDefault(),x.textContent=L.value,j.textContent=w.value;var n,r=v.querySelector(".popup__button");r.textContent="Сохранение...",(n={title:L.value,description:w.value},fetch("".concat(o.url,"/users/me"),{method:"PATCH",headers:o.headers,body:JSON.stringify({name:n.title,about:n.description})}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка запроса редактирования профиля ",e)}))).then((function(e){x.textContent=e.name,j.textContent=e.about})).catch((function(e){console.error("Ошибка при сохранение профиля:",e)})).finally((function(){r.textContent="Сохранение",t(m)}))})),g.addEventListener("submit",(function(e){e.preventDefault();var r,c=v.querySelector(".popup__button");c.textContent="Сохранение...",(r={name:T.value,link:A.value,owner:{id:I}},fetch("".concat(o.url,"/cards"),{method:"POST",headers:o.headers,body:JSON.stringify({name:r.name,link:r.link})}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка запроса добавления карты ",e)}))).then((function(e){f.prepend(u(I,{name:e.name,link:e.link},(function(t){return a(e,t)}),(function(t){return i(e,t)}),n))})).catch((function(e){console.error("Ошибка при сохранение карточки:",e)})).finally((function(){c.textContent="Сохранение",g.reset(),l(g,M),t(v)}))})),E.addEventListener("submit",(function(e){e.preventDefault();var n=q.dataset.cardId;(function(e){return fetch("".concat(o.url,"/cards/").concat(e),{method:"DELETE",headers:o.headers}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка запроса удаления карты ",e)}))})(n).then((function(){var e=document.querySelector('.card[data-card-id="'.concat(n,'"]'));e&&e.remove()})).catch((function(e){console.error("Ошибка при удаление карточки:",e)})).finally((function(){t(q)}))})),b.addEventListener("submit",(function(e){e.preventDefault();var n,r=v.querySelector(".popup__button");r.textContent="Сохранение...",(n=D.value,fetch("".concat(o.url,"/users/me/avatar"),{method:"PATCH",headers:o.headers,body:JSON.stringify({avatar:n})}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка запроса редактирования профиля ",e)}))).then((function(e){B.style.backgroundImage="url(".concat(e.avatar,")")})).catch((function(e){console.error("Ошибка при обновление аватара:",e)})).finally((function(){r.textContent="Сохранение",t(k)}))})),[m,v,S,q,k].forEach((function(e){e.addEventListener("click",(function(n){(n.target===e||n.target.classList.contains("popup__close"))&&t(e)}))})),function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((function(t){var n=Array.from(t.querySelectorAll(e.inputSelector)),r=t.querySelector(e.submitButtonSelector);n.forEach((function(o){o.addEventListener("input",(function(){!function(e,t,n){t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage||"Недопустимый формат строки"):t.setCustomValidity(""),t.validity.valid?s(e,t,n):function(e,t,n,r){var o=p(e,t);t.classList.add(r.inputErrorClass),o.textContent=n,o.classList.add(r.errorClass)}(e,t,t.validationMessage,n)}(t,o,e),d(n,r,e)}))}))}))}(M),fetch("".concat(o.url,"/users/me"),{headers:o.headers}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка загрузки профиля ",e)})).then((function(e){I=e._id,x.textContent=e.name,j.textContent=e.about,B.style.backgroundImage="url(".concat(e.avatar,")")})),fetch("".concat(o.url,"/cards"),{headers:o.headers}).then((function(e){return e.json()})).catch((function(e){return console.error("Ошибка загрузки карточек ",e)})).then((function(e){var t=e.map((function(e){return{id:e.id,name:e.name,link:e.link,likes:e.likes,owner:{id:e.owner._id,name:e.owner.name,about:e.owner.about,avatar:e.owner.avatar}}}));f.innerHTML="",t.forEach((function(e){f.append(u(I,e,(function(t){return a(e,q)}),(function(t){return i(e,t)}),n))}))}))})();